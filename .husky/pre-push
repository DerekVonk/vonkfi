#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Pre-push hook for comprehensive test infrastructure validation
echo "ğŸš€ Running pre-push validations..."

# Check if we're on a protected branch
protected_branches="main|master|develop"
current_branch=$(git rev-parse --abbrev-ref HEAD)

if [[ "$current_branch" =~ $protected_branches ]]; then
    echo "ğŸ”’ Pushing to protected branch '$current_branch' - running comprehensive checks..."
    
    # Run all tests
    echo "ğŸ§ª Running comprehensive test suite..."
    if [ -f "./run-tests.sh" ]; then
        # Run smoke tests first
        echo "ğŸ”¥ Running smoke tests..."
        npm run test:smoke || {
            echo "âŒ Smoke tests failed"
            exit 1
        }
        
        # Run unit tests
        echo "ğŸ§ª Running unit tests..."
        npm run test:unit || {
            echo "âŒ Unit tests failed"
            exit 1
        }
        
        # Check coverage
        echo "ğŸ“Š Checking test coverage..."
        npm run test:coverage || {
            echo "âŒ Coverage check failed"
            exit 1
        }
    else
        echo "âŒ Test runner script not found"
        exit 1
    fi
    
    # Build check
    echo "ğŸ—ï¸ Checking build..."
    npm run build || {
        echo "âŒ Build failed"
        exit 1
    }
    
    # Security scan
    echo "ğŸ”’ Running security scan..."
    npm run security:scan || {
        echo "âš ï¸ Security scan warnings (continuing)"
    }
    
else
    echo "ğŸ“ Pushing to feature branch '$current_branch' - running basic checks..."
    
    # Basic validation for feature branches
    echo "ğŸ”§ Validating CI configuration..."
    if [ -f "./scripts/validate-ci-config.sh" ]; then
        ./scripts/validate-ci-config.sh || {
            echo "âŒ CI configuration validation failed"
            exit 1
        }
    fi
    
    # TypeScript check
    echo "ğŸ” Checking TypeScript..."
    npx tsc --noEmit || {
        echo "âŒ TypeScript compilation failed"
        exit 1
    }
    
    # Quick test run
    echo "ğŸ§ª Running quick tests..."
    npm run test:smoke || {
        echo "âŒ Smoke tests failed"
        exit 1
    }
fi

echo "âœ… Pre-push validations passed!"